<!-- GSAP + ScrollTrigger + Slick Carousel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  if (typeof gsap === "undefined" || typeof ScrollTrigger === "undefined") return;
  gsap.registerPlugin(ScrollTrigger);

  const container = document.querySelector(".card_container"),
    cardParent = document.querySelector(".card_parent"),
    cards = gsap.utils.toArray(".ls_card"),
    images = gsap.utils.toArray(".card_wrap_img .card_img");

  if (!container || !cards.length || !images.length) return;

  const isMobile = window.innerWidth <= 768;

  // Mobile: move images into cards and skip animations/pinning
  if (isMobile) {
    const imageWrap = document.querySelector(".card_wrap_img");
    if (imageWrap) imageWrap.style.display = "none";

    cards.forEach((card, i) => {
      const title = card.querySelector(".ls_card_title");
      const srcImg = images[i];
      if (!title || !srcImg) return;
      const cloned = srcImg.cloneNode(true);
      cloned.classList.add("inline_card_img");
      cloned.removeAttribute("style");
      card.insertBefore(cloned, title);
    });

    // Ensure no scroll triggers are running
    ScrollTrigger.getAll().forEach(t => t.kill());
    return;
  }

  let mainPin;

  function init() {
    // Kill old triggers before re-init
    ScrollTrigger.getAll().forEach(t => t.kill());
    if (mainPin) {
      mainPin.kill();
      mainPin = null;
    }

    // Center first and last cards with dynamic padding
    const firstH = cards[0].offsetHeight || 0;
    const lastH = cards[cards.length - 1].offsetHeight || 0;
    const center = window.innerHeight / 2;
    const padTop = Math.max(0, center - firstH / 2);
    const padBottom = Math.max(0, center - lastH / 2);
    cardParent.style.paddingTop = padTop + "px";
    cardParent.style.paddingBottom = padBottom + "px";

    // Reset image states
    gsap.set(images, { opacity: 0, force3D: true, overwrite: true });
    gsap.set(images[0], { opacity: 1, force3D: true, overwrite: true });
    cards.forEach((c, i) => c.classList.toggle("active", i === 0));

    // Pin left image container for the entire cards scroll
    const total = Math.max(0, cardParent.scrollHeight - window.innerHeight + padTop + padBottom);
    mainPin = ScrollTrigger.create({
      trigger: container,
      start: "top top",
      end: `+=${total}`,
      pin: ".card_wrap_img",
      pinSpacing: true,
      anticipatePin: 1,
      pinType: "transform",
      invalidateOnRefresh: true,
      scrub: 1,
      onUpdate: handleScroll,
    });

    ScrollTrigger.refresh();
  }

  function handleScroll(self) {
    const viewCenter = window.innerHeight / 2;
    let closest = 0;
    let minDist = Infinity;
    for (let i = 0; i < cards.length; i++) {
      const rect = cards[i].getBoundingClientRect();
      const c = rect.top + rect.height / 2;
      const d = Math.abs(c - viewCenter);
      if (d < minDist) { minDist = d; closest = i; }
    }
    setActive(closest);
  }

  function setActive(i) {
    // Toggle card active state
    cards.forEach((c, idx) => c.classList.toggle("active", idx === i));

    // Animate image transitions
    images.forEach((img, idx) => {
      if (idx === i) {
        gsap.to(img, { opacity: 1, duration: 0.35, overwrite: "auto", force3D: true });
      } else {
        gsap.to(img, { opacity: 0, duration: 0.2, overwrite: "auto", force3D: true });
      }
    });
  }

  init();

  // Re-init on resize
  let resizeTimeout;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      init();
      ScrollTrigger.update();
    }, 150);
  });
});

</script>